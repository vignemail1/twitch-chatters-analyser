# Configuration direnv/mise pour charger automatiquement .env
# Compatible avec mise (https://mise.jdx.dev) et fnox (https://fnox.jdx.dev)

# D√©tecter le profil depuis la variable d'environnement ou utiliser development par d√©faut
export MISE_ENV=${MISE_ENV:-development}

echo "üåê Environnement: $MISE_ENV"

# Activer mise
if command -v mise &> /dev/null; then
  eval "$(mise activate bash)"
  mise trust 2>/dev/null || true
fi

# Activer fnox (si install√©)
if command -v fnox &> /dev/null; then
  eval "$(fnox activate bash)"
fi

# Charger le .env correspondant au profil
ENV_FILE=".env.$MISE_ENV"

if [ -f "$ENV_FILE" ]; then
  echo "‚úÖ Chargement de $ENV_FILE"
  dotenv "$ENV_FILE"
  
  # Charger aussi le .env.local si pr√©sent (overrides locaux)
  if [ -f "${ENV_FILE}.local" ]; then
    echo "üìù Chargement de ${ENV_FILE}.local (overrides locaux)"
    dotenv "${ENV_FILE}.local"
  fi
else
  echo "‚ö†Ô∏è  Fichier $ENV_FILE manquant"
  echo "üìù Actions possibles :"
  echo "  1. Copier .env.example vers $ENV_FILE"
  echo "  2. G√©n√©rer les secrets: mise run env-generate"
  echo "  3. Remplir les valeurs"
fi

# V√©rifier que les variables critiques sont d√©finies
if [ -f "$ENV_FILE" ]; then
  REQUIRED_VARS=(
    "APP_ENV"
    "TWITCH_CLIENT_ID"
    "TWITCH_CLIENT_SECRET"
    "MYSQL_ROOT_PASSWORD"
    "MYSQL_PASSWORD"
    "APP_SESSION_SECRET"
    "ACME_EMAIL"
    "TRAEFIK_AUTH"
  )
  
  MISSING_VARS=()
  for var in "${REQUIRED_VARS[@]}"; do
    if [ -z "${!var}" ]; then
      MISSING_VARS+=("$var")
    fi
  done
  
  if [ ${#MISSING_VARS[@]} -gt 0 ]; then
    echo ""
    echo "‚ùå Variables manquantes dans $ENV_FILE :"
    for var in "${MISSING_VARS[@]}"; do
      echo "  - $var"
    done
    echo ""
    echo "üîß Lancer: mise run env-generate"
  else
    echo "‚úÖ Toutes les variables requises sont d√©finies"
  fi
fi

# Afficher les infos de configuration
if [ -n "$APP_ENV" ]; then
  echo ""
  echo "üõ†Ô∏è  Configuration:"
  echo "  - Environnement: $APP_ENV"
  echo "  - Redirect URL: ${TWITCH_REDIRECT_URL:-non d√©fini}"
  echo "  - Monitoring: ${ENABLE_MONITORING:-false}"
  echo ""
  echo "üöÄ D√©marrage: mise run up"
  echo "üìä Logs: mise run logs"
fi
