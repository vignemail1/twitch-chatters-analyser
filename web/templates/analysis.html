{{ define "analysis_page" }}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <title>{{ .Title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="/static/css/main.css" rel="stylesheet" />
</head>
<body class="dark">
<header>
    <h1>Twitch Chatters Analyser</h1>
    <div class="user-info">
        {{ if .CurrentUser }}
            Connect√© en tant que <strong>{{ .CurrentUser.DisplayName }}</strong> ({{ .CurrentUser.Login }})
            <p><a href="/channels">Voir mes cha√Ænes mod√©r√©es</a></p>
            <p><a href="/analysis">Voir l'analyse de la session</a></p>
        {{ else }}
            <a href="/auth/login">Se connecter avec Twitch</a>
        {{ end }}
    </div>
</header>
<main>
<h2>üìä Analyse de la session</h2>

<div class="info" style="margin-bottom: 2rem;">
    <p><strong>Session UUID :</strong> <code style="background-color: #0e0e10; padding: 0.2rem 0.4rem; border-radius: 3px;">{{ .SessionUUID }}</code></p>
    {{ if .BroadcasterID }}
    <p><strong>Filtr√© pour :</strong> Broadcaster ID {{ .BroadcasterID }}</p>
    {{ end }}
</div>

{{ if .Summary }}
    <div style="background-color: #18181b; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid #9147ff;">
        <h3 style="margin-top: 0; color: #9147ff;">üìä R√©sum√© global</h3>
        <p style="font-size: 1.2rem; margin: 0.5rem 0;"><strong>{{ .Summary.TotalAccounts }}</strong> comptes distincts captur√©s</p>
        <p style="color: #adadb8; font-size: 0.9rem; margin: 0.5rem 0;">Donn√©es g√©n√©r√©es le {{ .Summary.GeneratedAt.Format "02/01/2006 √† 15:04" }}</p>
    </div>

    <h3>üìÖ Top 10 des jours de cr√©ation de comptes</h3>

    {{ if not .Summary.TopDays }}
        <div class="info">
            <p>Aucune donn√©e disponible.</p>
            <p>Les comptes captur√©s n'ont pas encore √©t√© enrichis par le worker, ou aucun compte n'a de date de cr√©ation connue.</p>
        </div>
    {{ else }}
        <!-- Analyse automatique des patterns -->
        {{ $maxCount := 0 }}
        {{ $totalInTop10 := 0 }}
        {{ range .Summary.TopDays }}
            {{ if gt .Count $maxCount }}{{ $maxCount = .Count }}{{ end }}
            {{ $totalInTop10 = add $totalInTop10 .Count }}
        {{ end }}
        
        {{ $percentInTop10 := 0 }}
        {{ if gt .Summary.TotalAccounts 0 }}
            {{ $percentInTop10 = div (mul $totalInTop10 100) .Summary.TotalAccounts }}
        {{ end }}

        <!-- Alertes selon les seuils -->
        {{ if ge $maxCount 100 }}
        <div class="error" style="margin-bottom: 1.5rem;">
            <p><strong>‚ö†Ô∏è ALERTE CRITIQUE</strong></p>
            <p>Un pic de <strong>{{ $maxCount }} comptes</strong> cr√©√©s le m√™me jour a √©t√© d√©tect√©.</p>
            <p>Ceci est <strong>extr√™mement suspect</strong> et indique tr√®s probablement une vague de bots.</p>
        </div>
        {{ else if ge $maxCount 50 }}
        <div class="error" style="margin-bottom: 1.5rem; background-color: #78350f; border-left-color: #f59e0b;">
            <p><strong>‚ö†Ô∏è ALERTE</strong></p>
            <p>Un pic de <strong>{{ $maxCount }} comptes</strong> cr√©√©s le m√™me jour a √©t√© d√©tect√©.</p>
            <p>Ceci est <strong>suspect</strong> et pourrait indiquer des bots.</p>
        </div>
        {{ else if ge $maxCount 30 }}
        <div class="info" style="margin-bottom: 1.5rem; background-color: #1e3a8a;">
            <p><strong>üîç ATTENTION</strong></p>
            <p>Un pic de <strong>{{ $maxCount }} comptes</strong> cr√©√©s le m√™me jour a √©t√© d√©tect√©.</p>
            <p>Surveiller ce comportement, cela pourrait √™tre suspect selon le contexte.</p>
        </div>
        {{ end }}

        {{ if ge $percentInTop10 40 }}
        <div class="info" style="margin-bottom: 1.5rem;">
            <p><strong>üìä Concentration √©lev√©e</strong></p>
            <p><strong>{{ $percentInTop10 }}%</strong> des comptes ({{ $totalInTop10 }}/{{ .Summary.TotalAccounts }}) ont √©t√© cr√©√©s sur seulement 10 jours.</p>
            <p>Une forte concentration peut indiquer des bots si les dates sont r√©centes.</p>
        </div>
        {{ end }}

        <table>
            <thead>
            <tr>
                <th>Date de cr√©ation</th>
                <th>Nombre de comptes</th>
                <th>% du total</th>
                <th>Indicateur</th>
            </tr>
            </thead>
            <tbody>
            {{ range .Summary.TopDays }}
                {{ $percent := 0 }}
                {{ if gt $.Summary.TotalAccounts 0 }}
                    {{ $percent = div (mul .Count 100) $.Summary.TotalAccounts }}
                {{ end }}
                <tr>
                    <td><strong>{{ .Date }}</strong></td>
                    <td>{{ .Count }}</td>
                    <td>{{ $percent }}%</td>
                    <td>
                        {{ if ge .Count 100 }}
                            <span style="color: #ef4444; font-weight: 600;">‚ùå CRITIQUE</span>
                        {{ else if ge .Count 50 }}
                            <span style="color: #f59e0b; font-weight: 600;">‚ö†Ô∏è SUSPECT</span>
                        {{ else if ge .Count 30 }}
                            <span style="color: #3b82f6;">üîç √Ä surveiller</span>
                        {{ else }}
                            <span style="color: #10b981;">‚úÖ Normal</span>
                        {{ end }}
                    </td>
                </tr>
            {{ end }}
            </tbody>
        </table>

        <div style="margin-top: 2rem; padding: 1rem; background-color: #18181b; border-radius: 4px;">
            <h4 style="margin-top: 0; color: #efeff1;">üìñ Guide d'interpr√©tation</h4>
            <ul style="color: #adadb8; margin-left: 1.5rem; line-height: 1.8;">
                <li><span style="color: #ef4444; font-weight: 600;">‚ùå CRITIQUE (100+)</span> : Vague de bots presque certaine</li>
                <li><span style="color: #f59e0b; font-weight: 600;">‚ö†Ô∏è SUSPECT (50-99)</span> : Tr√®s probablement des bots</li>
                <li><span style="color: #3b82f6;">üîç √Ä surveiller (30-49)</span> : Potentiellement suspect selon contexte</li>
                <li><span style="color: #10b981;">‚úÖ Normal (< 30)</span> : Distribution attendue</li>
            </ul>
            <p style="color: #adadb8; margin-top: 1rem; font-size: 0.9rem;">
                <strong>Note :</strong> Ces seuils sont indicatifs. V√©rifiez toujours le contexte (raids, √©v√©nements sp√©ciaux, etc.).
            </p>
        </div>
    {{ end }}
{{ else }}
    <div class="info">
        <p><strong>Aucun r√©sum√© disponible pour cette session.</strong></p>
        <p>Assurez-vous d'avoir captur√© des chatters depuis la page <a href="/channels">/channels</a>.</p>
        <p>Le worker peut prendre quelques minutes pour enrichir les donn√©es des comptes.</p>
    </div>
{{ end }}

<div style="margin-top: 2rem; text-align: center;">
    <a href="/channels" style="display: inline-block; background-color: #9147ff; color: #fff; padding: 0.75rem 1.5rem; border-radius: 4px; text-decoration: none; font-weight: 600;">
        ‚Üê Retour aux cha√Ænes
    </a>
</div>
</main>
</body>
</html>
{{ end }}
