{{ define "analysis_page" }}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <title>{{ .Title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="/static/css/main.css" rel="stylesheet" />
    <script src="/static/js/timezone.js"></script>
</head>
<body class="dark">
<header>
    <h1>Twitch Chatters Analyser</h1>
    <div class="user-info">
        {{ if .CurrentUser }}
            ConnectÃ© en tant que <strong>{{ .CurrentUser.DisplayName }}</strong> ({{ .CurrentUser.Login }})
            <p><a href="/">Accueil</a> | <a href="/channels">Mes chaÃ®nes</a> | <a href="/sessions">Sessions sauvegardÃ©es</a></p>
            <p><a href="/auth/logout" style="color: #ef4444;">Se dÃ©connecter</a></p>
        {{ else }}
            <a href="/auth/login">Se connecter avec Twitch</a>
        {{ end }}
    </div>
</header>
<main>
<h2>ğŸ“ŠAnalyse de {{ if .IsSaved }}session sauvegardÃ©e{{ else }}la session{{ end }}</h2>

{{ if .Purged }}
<div class="info" style="background-color: #15803d; border-left-color: #22c55e; margin-bottom: 1.5rem;">
    <p><strong>âœ… Session purgÃ©e avec succÃ¨s</strong></p>
    <p>Toutes les captures ont Ã©tÃ© supprimÃ©es. Vous pouvez recommencer une nouvelle analyse.</p>
</div>
{{ end }}

<div class="info" style="margin-bottom: 2rem;">
    <p><strong>Session UUID :</strong> <code style="background-color: #0e0e10; padding: 0.2rem 0.4rem; border-radius: 3px;">{{ .SessionUUID }}</code></p>
    {{ if .IsSaved }}
    <p style="color: #22c55e; font-weight: 600;">âœ”ï¸ Cette session est sauvegardÃ©e</p>
    {{ end }}
    
    <div style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
        {{ if .IsSaved }}
            <a href="/sessions/export/{{ .SessionUUID }}?format=csv" style="display: inline-block; background-color: #047857; color: #fff; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; font-weight: 600;">
                ğŸ“„ Exporter CSV
            </a>
            <a href="/sessions/export/{{ .SessionUUID }}?format=json" style="display: inline-block; background-color: #0369a1; color: #fff; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; font-weight: 600;">
                ğŸ“‹ Exporter JSON
            </a>
        {{ else }}
            <a href="/analysis/export?format=csv" style="display: inline-block; background-color: #047857; color: #fff; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; font-weight: 600;">
                ğŸ“„ Exporter CSV
            </a>
            <a href="/analysis/export?format=json" style="display: inline-block; background-color: #0369a1; color: #fff; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; font-weight: 600;">
                ğŸ“‹ Exporter JSON
            </a>
        {{ end }}
    </div>
</div>

{{ if .Summary }}
    <!-- Filtre par chaÃ®nes (si plusieurs broadcasters prÃ©sents) -->
    {{ if gt (len .Summary.Broadcasters) 1 }}
    <div style="background-color: #18181b; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid #9147ff;">
        <h3 style="margin-top: 0; color: #9147ff;">ğŸ” Filtrer par chaÃ®ne</h3>
        <form method="GET" id="filter-form">
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 0.75rem; margin-bottom: 1rem;">
                {{ range .Summary.Broadcasters }}
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background-color: #0e0e10; border-radius: 4px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s;" onmouseover="this.style.borderColor='#9147ff'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='transparent'">
                    <input 
                        type="checkbox" 
                        name="broadcaster_id" 
                        value="{{ .BroadcasterID }}" 
                        {{ if contains $.BroadcasterIDs .BroadcasterID }}checked{{ end }}
                        style="width: 18px; height: 18px; cursor: pointer;"
                        onchange="document.getElementById('filter-form').submit()"
                    />
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #efeff1;">{{ .BroadcasterLogin }}</div>
                        <div style="font-size: 0.85rem; color: #adadb8;">{{ .CaptureCount }} capture(s)</div>
                    </div>
                </label>
                {{ end }}
            </div>
            
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                <button type="submit" style="background-color: #9147ff; color: #fff; padding: 0.5rem 1.5rem; border-radius: 4px; border: none; font-weight: 600; cursor: pointer;">
                    Appliquer le filtre
                </button>
                
                {{ if .BroadcasterIDs }}
                    {{ if .IsSaved }}
                        <a href="/analysis/saved/{{ .SessionUUID }}" style="display: inline-block; background-color: #dc2626; color: #fff; padding: 0.5rem 1.5rem; border-radius: 4px; text-decoration: none; font-weight: 600;">
                            âŒ RÃ©initialiser les filtres
                        </a>
                    {{ else }}
                        <a href="/analysis" style="display: inline-block; background-color: #dc2626; color: #fff; padding: 0.5rem 1.5rem; border-radius: 4px; text-decoration: none; font-weight: 600;">
                            âŒ RÃ©initialiser les filtres
                        </a>
                    {{ end }}
                    <span style="color: #adadb8; font-size: 0.9rem;">
                        ğŸ” {{ len .BroadcasterIDs }} filtre(s) actif(s)
                    </span>
                {{ end }}
            </div>
        </form>
    </div>
    {{ end }}

    <div style="background-color: #18181b; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid #22c55e;">
        <h3 style="margin-top: 0; color: #22c55e;">ğŸ“Š RÃ©sumÃ© global</h3>
        {{ if .BroadcasterIDs }}
            <p style="color: #f59e0b; margin-bottom: 1rem;">
                ğŸ” Vue filtrÃ©e : {{ len .BroadcasterIDs }} chaÃ®ne(s) sÃ©lectionnÃ©e(s)
            </p>
        {{ end }}
        <p style="font-size: 1.2rem; margin: 0.5rem 0;"><strong>{{ .Summary.TotalAccounts }}</strong> comptes distincts capturÃ©s</p>
        <p style="color: #adadb8; font-size: 0.9rem; margin: 0.5rem 0;" data-utc-date="{{ .Summary.GeneratedAt.Format "2006-01-02T15:04:05Z07:00" }}" data-format="datetime">DonnÃ©es gÃ©nÃ©rÃ©es le {{ .Summary.GeneratedAt.Format "02/01/2006 Ã  15:04" }}</p>
    </div>

    <!-- Section comptes suspects avec renommages multiples -->
    {{ if gt .Summary.SuspiciousRenamesCount 0 }}
    <div style="background-color: #450a0a; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid #ef4444;">
        <h3 style="margin-top: 0; color: #ef4444;">âš ï¸ Comptes suspects avec renommages multiples</h3>
        <p style="color: #fca5a5; font-weight: 600; font-size: 1.1rem; margin-bottom: 1rem;">
            ğŸ”´ {{ .Summary.SuspiciousRenamesCount }} compte(s) ont changÃ© de nom 3+ fois
        </p>
        <p style="color: #fecaca; margin-bottom: 1.5rem;">
            Les comptes qui changent frÃ©quemment de nom sont souvent des bots tentant d'Ã©viter la dÃ©tection.
        </p>

        <table style="width: 100%;">
            <thead>
                <tr>
                    <th style="text-align: left;">User ID</th>
                    <th style="text-align: left;">Nom actuel</th>
                    <th style="text-align: center;">Changements</th>
                    <th style="text-align: center;">Niveau</th>
                    <th style="text-align: center;">Action</th>
                </tr>
            </thead>
            <tbody>
                {{ range .Summary.SuspiciousAccounts }}
                <tr style="background-color: #7f1d1d;">
                    <td><code style="background-color: #0e0e10; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.85rem;">{{ .TwitchUserID }}</code></td>
                    <td>
                        <strong style="color: #efeff1;">{{ .Login }}</strong>
                        {{ if ne .Login .DisplayName }}
                            <span style="color: #adadb8; font-size: 0.9rem;">({{ .DisplayName }})</span>
                        {{ end }}
                    </td>
                    <td style="text-align: center;">
                        <span style="background-color: #dc2626; color: #fff; padding: 0.25rem 0.75rem; border-radius: 12px; font-weight: 700; font-size: 0.9rem;">
                            {{ .RenameCount }}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        {{ if ge .RenameCount 6 }}
                            <span style="color: #dc2626; font-weight: 700;">ğŸ”´ TRÃˆS SUSPECT</span>
                        {{ else if ge .RenameCount 3 }}
                            <span style="color: #f59e0b; font-weight: 600;">ğŸŸ  SUSPECT</span>
                        {{ else }}
                            <span style="color: #3b82f6;">ğŸ”µ Ã€ surveiller</span>
                        {{ end }}
                    </td>
                    <td style="text-align: center;">
                        <a href="/accounts/{{ .TwitchUserID }}/history" style="display: inline-block; background-color: #9147ff; color: #fff; padding: 0.35rem 0.75rem; border-radius: 4px; text-decoration: none; font-size: 0.85rem; font-weight: 600;">
                            ğŸ” Voir historique
                        </a>
                    </td>
                </tr>
                {{ end }}
            </tbody>
        </table>

        <div style="margin-top: 1.5rem; padding: 1rem; background-color: #7f1d1d; border-radius: 4px;">
            <h4 style="margin-top: 0; color: #fecaca;">ğŸ“Š CritÃ¨res de suspicion</h4>
            <ul style="color: #fecaca; margin-left: 1.5rem; line-height: 1.8;">
                <li><span style="color: #dc2626; font-weight: 700;">ğŸ”´ TRÃˆS SUSPECT (6+)</span> : Bot presque certain, changements frÃ©quents pour Ã©viter les bans</li>
                <li><span style="color: #f59e0b; font-weight: 600;">ğŸŸ  SUSPECT (3-5)</span> : Comportement anormal, Ã  investiguer</li>
                <li><span style="color: #3b82f6;">ğŸ”µ Ã€ surveiller (1-2)</span> : Peut Ãªtre lÃ©gitime (rebranding, etc.)</li>
            </ul>
        </div>
    </div>
    {{ end }}

    <h3>ğŸ“… Top 10 des jours de crÃ©ation de comptes</h3>

    {{ if not .Summary.TopDays }}
        <div class="info">
            <p>Aucune donnÃ©e disponible.</p>
            <p>Les comptes capturÃ©s n'ont pas encore Ã©tÃ© enrichis par le worker, ou aucun compte n'a de date de crÃ©ation connue.</p>
        </div>
    {{ else }}
        <table>
            <thead>
            <tr>
                <th>Date de crÃ©ation</th>
                <th>Nombre de comptes</th>
                <th>% du total</th>
                <th>Indicateur</th>
            </tr>
            </thead>
            <tbody>
            {{ range .Summary.TopDays }}
                <tr>
                    <td><strong>{{ .Date }}</strong></td>
                    <td>{{ .Count }}</td>
                    <td>
                        {{ if gt $.Summary.TotalAccounts 0 }}
                            {{ div (mul .Count 100) $.Summary.TotalAccounts }}%
                        {{ else }}
                            0%
                        {{ end }}
                    </td>
                    <td>
                        {{ if ge .Count 100 }}
                            <span style="color: #ef4444; font-weight: 600;">âŒ CRITIQUE</span>
                        {{ else if ge .Count 50 }}
                            <span style="color: #f59e0b; font-weight: 600;">âš ï¸ SUSPECT</span>
                        {{ else if ge .Count 30 }}
                            <span style="color: #3b82f6;">ğŸ” Ã€ surveiller</span>
                        {{ else }}
                            <span style="color: #10b981;">âœ… Normal</span>
                        {{ end }}
                    </td>
                </tr>
            {{ end }}
            </tbody>
        </table>

        <div style="margin-top: 2rem; padding: 1rem; background-color: #18181b; border-radius: 4px;">
            <h4 style="margin-top: 0; color: #efeff1;">ğŸ“– Guide d'interprÃ©tation</h4>
            <ul style="color: #adadb8; margin-left: 1.5rem; line-height: 1.8;">
                <li><span style="color: #ef4444; font-weight: 600;">âŒ CRITIQUE (100+)</span> : Vague de bots presque certaine</li>
                <li><span style="color: #f59e0b; font-weight: 600;">âš ï¸ SUSPECT (50-99)</span> : TrÃ¨s probablement des bots</li>
                <li><span style="color: #3b82f6;">ğŸ” Ã€ surveiller (30-49)</span> : Potentiellement suspect selon contexte</li>
                <li><span style="color: #10b981;">âœ… Normal (< 30)</span> : Distribution attendue</li>
            </ul>
            <p style="color: #adadb8; margin-top: 1rem; font-size: 0.9rem;">
                <strong>Note :</strong> Ces seuils sont indicatifs. VÃ©rifiez toujours le contexte (raids, Ã©vÃ©nements spÃ©ciaux, etc.).
            </p>
        </div>
    {{ end }}
{{ else }}
    <div class="info">
        <p><strong>Aucun rÃ©sumÃ© disponible pour cette session.</strong></p>
        <p>Assurez-vous d'avoir capturÃ© des chatters depuis la page <a href="/channels">/channels</a>.</p>
        <p>Le worker peut prendre quelques minutes pour enrichir les donnÃ©es des comptes.</p>
    </div>
{{ end }}

<div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #2d2d31; display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; align-items: center;">
    {{ if .IsSaved }}
        <a href="/sessions" style="display: inline-block; background-color: #9147ff; color: #fff; padding: 0.75rem 1.5rem; border-radius: 4px; text-decoration: none; font-weight: 600;">
            â† Retour aux sessions sauvegardÃ©es
        </a>
    {{ else }}
        <a href="/channels" style="display: inline-block; background-color: #9147ff; color: #fff; padding: 0.75rem 1.5rem; border-radius: 4px; text-decoration: none; font-weight: 600;">
            â† Retour aux chaÃ®nes
        </a>
        
        <form method="POST" action="/sessions/save" style="display: inline-block;">
            <button type="submit" style="background-color: #15803d; color: #fff; padding: 0.75rem 1.5rem; border-radius: 4px; border: none; font-weight: 600; cursor: pointer; font-size: 1rem;">
                ğŸ’¾ Sauvegarder la session
            </button>
        </form>
        
        <form method="POST" action="/sessions/purge" style="display: inline-block;" onsubmit="return confirm('Voulez-vous vraiment supprimer TOUTES les captures de cette session ? Cette action est irrÃ©versible.')">
            <button type="submit" style="background-color: #991b1b; color: #fff; padding: 0.75rem 1.5rem; border-radius: 4px; border: none; font-weight: 600; cursor: pointer; font-size: 1rem;">
                ğŸ—‘ï¸ Purger la session
            </button>
        </form>
    {{ end }}
</div>

{{ if not .IsSaved }}
<div style="margin-top: 2rem; padding: 1rem; background-color: #18181b; border-radius: 4px;">
    <h4 style="margin-top: 0; color: #efeff1;">ğŸ’¡ Astuce</h4>
    <p style="color: #adadb8; margin: 0;">
        <strong>Sauvegarder</strong> conserve cette session pour consultation ultÃ©rieure. 
        <strong>Purger</strong> supprime dÃ©finitivement toutes les captures de cette session active.
    </p>
</div>
{{ end }}
</main>
</body>
</html>
{{ end }}
