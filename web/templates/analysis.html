{{ define "analysis_page" }}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <title>{{ .Title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="/static/css/main.css" rel="stylesheet" />
    <script src="/static/js/timezone.js"></script>
</head>
<body class="dark">
<header>
    <h1>Twitch Chatters Analyser</h1>
    <div class="user-info">
        {{ if .CurrentUser }}
            ConnectÃ© en tant que <strong>{{ .CurrentUser.DisplayName }}</strong> ({{ .CurrentUser.Login }})
            <p><a href="/">Accueil</a> | <a href="/channels">Mes chaÃ®nes</a> | <a href="/sessions">Sessions sauvegardÃ©es</a></p>
            <p><a href="/auth/logout" style="color: #ef4444;">Se dÃ©connecter</a></p>
        {{ else }}
            <a href="/auth/login">Se connecter avec Twitch</a>
        {{ end }}
    </div>
</header>
<main>
<h2>ğŸ“Š Analyse de {{ if .IsSaved }}session sauvegardÃ©e{{ else }}la session{{ end }}</h2>

{{ if .Purged }}
<div class="info" style="background-color: #15803d; border-left-color: #22c55e; margin-bottom: 1.5rem;">
    <p><strong>âœ… Session purgÃ©e avec succÃ¨s</strong></p>
    <p>Toutes les captures ont Ã©tÃ© supprimÃ©es. Vous pouvez recommencer une nouvelle analyse.</p>
</div>
{{ end }}

<div class="info" style="margin-bottom: 2rem;">
    <p><strong>Session UUID :</strong> <code style="background-color: #0e0e10; padding: 0.2rem 0.4rem; border-radius: 3px;">{{ .SessionUUID }}</code></p>
    {{ if .IsSaved }}
    <p style="color: #22c55e; font-weight: 600;">âœ”ï¸ Cette session est sauvegardÃ©e</p>
    {{ end }}
    {{ if .BroadcasterID }}
    <p><strong>FiltrÃ© pour :</strong> Broadcaster ID {{ .BroadcasterID }}</p>
    {{ end }}
    
    <div style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
        {{ if .IsSaved }}
            <a href="/sessions/export/{{ .SessionUUID }}?format=csv" style="display: inline-block; background-color: #047857; color: #fff; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; font-weight: 600;">
                ğŸ“„ Exporter CSV
            </a>
            <a href="/sessions/export/{{ .SessionUUID }}?format=json" style="display: inline-block; background-color: #0369a1; color: #fff; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; font-weight: 600;">
                ğŸ“‹ Exporter JSON
            </a>
        {{ else }}
            <a href="/analysis/export?format=csv" style="display: inline-block; background-color: #047857; color: #fff; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; font-weight: 600;">
                ğŸ“„ Exporter CSV
            </a>
            <a href="/analysis/export?format=json" style="display: inline-block; background-color: #0369a1; color: #fff; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; font-weight: 600;">
                ğŸ“‹ Exporter JSON
            </a>
        {{ end }}
    </div>
</div>

{{ if .Summary }}
    <div style="background-color: #18181b; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid #9147ff;">
        <h3 style="margin-top: 0; color: #9147ff;">ğŸ“Š RÃ©sumÃ© global</h3>
        <p style="font-size: 1.2rem; margin: 0.5rem 0;"><strong>{{ .Summary.TotalAccounts }}</strong> comptes distincts capturÃ©s</p>
        <p style="color: #adadb8; font-size: 0.9rem; margin: 0.5rem 0;" data-utc-date="{{ .Summary.GeneratedAt.Format "2006-01-02T15:04:05Z07:00" }}" data-format="datetime">DonnÃ©es gÃ©nÃ©rÃ©es le {{ .Summary.GeneratedAt.Format "02/01/2006 Ã  15:04" }}</p>
    </div>

    <h3>ğŸ“… Top 10 des jours de crÃ©ation de comptes</h3>

    {{ if not .Summary.TopDays }}
        <div class="info">
            <p>Aucune donnÃ©e disponible.</p>
            <p>Les comptes capturÃ©s n'ont pas encore Ã©tÃ© enrichis par le worker, ou aucun compte n'a de date de crÃ©ation connue.</p>
        </div>
    {{ else }}
        <table>
            <thead>
            <tr>
                <th>Date de crÃ©ation</th>
                <th>Nombre de comptes</th>
                <th>% du total</th>
                <th>Indicateur</th>
            </tr>
            </thead>
            <tbody>
            {{ range .Summary.TopDays }}
                <tr>
                    <td><strong>{{ .Date }}</strong></td>
                    <td>{{ .Count }}</td>
                    <td>
                        {{ if gt $.Summary.TotalAccounts 0 }}
                            {{ div (mul .Count 100) $.Summary.TotalAccounts }}%
                        {{ else }}
                            0%
                        {{ end }}
                    </td>
                    <td>
                        {{ if ge .Count 100 }}
                            <span style="color: #ef4444; font-weight: 600;">âŒ CRITIQUE</span>
                        {{ else if ge .Count 50 }}
                            <span style="color: #f59e0b; font-weight: 600;">âš ï¸ SUSPECT</span>
                        {{ else if ge .Count 30 }}
                            <span style="color: #3b82f6;">ğŸ” Ã€ surveiller</span>
                        {{ else }}
                            <span style="color: #10b981;">âœ… Normal</span>
                        {{ end }}
                    </td>
                </tr>
            {{ end }}
            </tbody>
        </table>

        <div style="margin-top: 2rem; padding: 1rem; background-color: #18181b; border-radius: 4px;">
            <h4 style="margin-top: 0; color: #efeff1;">ğŸ“– Guide d'interprÃ©tation</h4>
            <ul style="color: #adadb8; margin-left: 1.5rem; line-height: 1.8;">
                <li><span style="color: #ef4444; font-weight: 600;">âŒ CRITIQUE (100+)</span> : Vague de bots presque certaine</li>
                <li><span style="color: #f59e0b; font-weight: 600;">âš ï¸ SUSPECT (50-99)</span> : TrÃ¨s probablement des bots</li>
                <li><span style="color: #3b82f6;">ğŸ” Ã€ surveiller (30-49)</span> : Potentiellement suspect selon contexte</li>
                <li><span style="color: #10b981;">âœ… Normal (< 30)</span> : Distribution attendue</li>
            </ul>
            <p style="color: #adadb8; margin-top: 1rem; font-size: 0.9rem;">
                <strong>Note :</strong> Ces seuils sont indicatifs. VÃ©rifiez toujours le contexte (raids, Ã©vÃ©nements spÃ©ciaux, etc.).
            </p>
        </div>
    {{ end }}
{{ else }}
    <div class="info">
        <p><strong>Aucun rÃ©sumÃ© disponible pour cette session.</strong></p>
        <p>Assurez-vous d'avoir capturÃ© des chatters depuis la page <a href="/channels">/channels</a>.</p>
        <p>Le worker peut prendre quelques minutes pour enrichir les donnÃ©es des comptes.</p>
    </div>
{{ end }}

<div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #2d2d31; display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; align-items: center;">
    {{ if .IsSaved }}
        <a href="/sessions" style="display: inline-block; background-color: #9147ff; color: #fff; padding: 0.75rem 1.5rem; border-radius: 4px; text-decoration: none; font-weight: 600;">
            â† Retour aux sessions sauvegardÃ©es
        </a>
    {{ else }}
        <a href="/channels" style="display: inline-block; background-color: #9147ff; color: #fff; padding: 0.75rem 1.5rem; border-radius: 4px; text-decoration: none; font-weight: 600;">
            â† Retour aux chaÃ®nes
        </a>
        
        <form method="POST" action="/sessions/save" style="display: inline-block;">
            <button type="submit" style="background-color: #15803d; color: #fff; padding: 0.75rem 1.5rem; border-radius: 4px; border: none; font-weight: 600; cursor: pointer; font-size: 1rem;">
                ğŸ’¾ Sauvegarder la session
            </button>
        </form>
        
        <form method="POST" action="/sessions/purge" style="display: inline-block;" onsubmit="return confirm('Voulez-vous vraiment supprimer TOUTES les captures de cette session ? Cette action est irrÃ©versible.')">
            <button type="submit" style="background-color: #991b1b; color: #fff; padding: 0.75rem 1.5rem; border-radius: 4px; border: none; font-weight: 600; cursor: pointer; font-size: 1rem;">
                ğŸ—‘ï¸ Purger la session
            </button>
        </form>
    {{ end }}
</div>

{{ if not .IsSaved }}
<div style="margin-top: 2rem; padding: 1rem; background-color: #18181b; border-radius: 4px;">
    <h4 style="margin-top: 0; color: #efeff1;">ğŸ’¡ Astuce</h4>
    <p style="color: #adadb8; margin: 0;">
        <strong>Sauvegarder</strong> conserve cette session pour consultation ultÃ©rieure. 
        <strong>Purger</strong> supprime dÃ©finitivement toutes les captures de cette session active.
    </p>
</div>
{{ end }}
</main>
</body>
</html>
{{ end }}
