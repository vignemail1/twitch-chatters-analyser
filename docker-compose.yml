services:
  db:
    image: mariadb:11.2
    container_name: twitch-chatters-db
    restart: unless-stopped
    environment:
      MARIADB_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpass}
      MARIADB_DATABASE: ${MYSQL_DATABASE:-twitch_chatters}
      MARIADB_USER: ${MYSQL_USER:-twitch}
      MARIADB_PASSWORD: ${MYSQL_PASSWORD:-twitchpass}
    command: [ "--character-set-server=utf8mb4", "--collation-server=utf8mb4_unicode_ci" ]
    volumes:
    - db_data:/var/lib/mysql
    - ./dev/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    networks:
    - backend
    healthcheck:
      test: [ "CMD-SHELL", "healthcheck.sh --connect --innodb_initialized" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  gateway:
    build:
      context: .
      dockerfile: ./cmd/gateway/Dockerfile
    container_name: twitch-chatters-gateway
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      twitch-api:
        condition: service_started
    ports:
    - "8080:8080"
    environment:
      APP_ENV: ${APP_ENV:-dev}
      APP_PORT: "8080"
      DB_HOST: db
      DB_PORT: "3306"
      DB_NAME: ${MYSQL_DATABASE:-twitch_chatters}
      DB_USER: ${MYSQL_USER:-twitch}
      DB_PASSWORD: ${MYSQL_PASSWORD:-twitchpass}
      TWITCH_CLIENT_ID: ${TWITCH_CLIENT_ID}
      TWITCH_CLIENT_SECRET: ${TWITCH_CLIENT_SECRET}
      TWITCH_REDIRECT_URL: ${TWITCH_REDIRECT_URL}
      APP_SESSION_SECRET: ${APP_SESSION_SECRET:-change-me}
      TWITCH_API_BASE_URL: http://twitch-api:8081
      ANALYSIS_BASE_URL: http://analysis:8083
    networks:
    - backend
    # - traefik
    labels:
    - "traefik.enable=true"
    - "traefik.http.routers.tca-gateway.rule=Host(`${TCA_HOSTNAME:-twitch-analyser.local}`)"
    - "traefik.http.routers.tca-gateway.entrypoints=websecure"
    - "traefik.http.routers.tca-gateway.tls=true"
    - "traefik.http.services.tca-gateway.loadbalancer.server.port=8080"

  twitch-api:
    build:
      context: .
      dockerfile: ./cmd/twitch-api/Dockerfile
    container_name: twitch-chatters-twitch-api
    restart: unless-stopped
    environment:
      APP_ENV: ${APP_ENV:-dev}
      APP_PORT: "8081"
      TWITCH_CLIENT_ID: ${TWITCH_CLIENT_ID}
      TWITCH_CLIENT_SECRET: ${TWITCH_CLIENT_SECRET}
      # Rate limiting: 10 req/sec = 600 req/min (marge sous les 800 de Twitch)
      RATE_LIMIT_REQUESTS_PER_SECOND: ${RATE_LIMIT_REQUESTS_PER_SECOND:-10}
    networks:
    - backend
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8081/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  worker:
    build:
      context: .
      dockerfile: ./cmd/worker/Dockerfile
    container_name: twitch-chatters-worker
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      twitch-api:
        condition: service_healthy
    environment:
      APP_ENV: ${APP_ENV:-dev}
      DB_HOST: db
      DB_PORT: "3306"
      DB_NAME: ${MYSQL_DATABASE:-twitch_chatters}
      DB_USER: ${MYSQL_USER:-twitch}
      DB_PASSWORD: ${MYSQL_PASSWORD:-twitchpass}
      TWITCH_API_BASE_URL: http://twitch-api:8081
      TWITCH_CLIENT_ID: ${TWITCH_CLIENT_ID}
      JOB_POLL_INTERVAL: ${JOB_POLL_INTERVAL:-2}
    networks:
    - backend

  analysis:
    build:
      context: .
      dockerfile: ./cmd/analysis/Dockerfile
    container_name: twitch-chatters-analysis
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    ports:
    - "8083:8083"
    environment:
      APP_ENV: ${APP_ENV:-dev}
      APP_PORT: "8083"
      DB_HOST: db
      DB_PORT: "3306"
      DB_NAME: ${MYSQL_DATABASE:-twitch_chatters}
      DB_USER: ${MYSQL_USER:-twitch}
      DB_PASSWORD: ${MYSQL_PASSWORD:-twitchpass}
    networks:
    - backend

networks:
  backend:
    driver: bridge
  # traefik:
  #   external: true

volumes:
  db_data:
