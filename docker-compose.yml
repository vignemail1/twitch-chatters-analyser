services:
  db:
    image: mysql:8.0
    container_name: twitch-chatters-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpass}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-twitch_chatters}
      MYSQL_USER: ${MYSQL_USER:-twitch}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-twitchpass}
    command: [ "--default-authentication-plugin=mysql_native_password", "--character-set-server=utf8mb4", "--collation-server=utf8mb4_unicode_ci" ]
    volumes:
    - db_data:/var/lib/mysql
    - ./dev/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro # (quand tu auras le schema)
    networks:
    - backend
    healthcheck:
      # Healthcheck simple MySQL[web:115][web:119][web:121]
      test: [ "CMD-SHELL", "mysqladmin ping -h localhost -u $$MYSQL_USER -p$$MYSQL_PASSWORD --silent" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  gateway:
    build:
      context: .
      dockerfile: ./cmd/gateway/Dockerfile
    container_name: twitch-chatters-gateway
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    ports:
    - "8080:8080"
    environment:
      APP_ENV: ${APP_ENV:-dev}
      APP_PORT: "8080"
      DB_HOST: db
      DB_PORT: "3306"
      DB_NAME: ${MYSQL_DATABASE:-twitch_chatters}
      DB_USER: ${MYSQL_USER:-twitch}
      DB_PASSWORD: ${MYSQL_PASSWORD:-twitchpass}
      TWITCH_CLIENT_ID: ${TWITCH_CLIENT_ID}
      TWITCH_CLIENT_SECRET: ${TWITCH_CLIENT_SECRET}
      TWITCH_REDIRECT_URL: ${TWITCH_REDIRECT_URL}
      # Clé de session (cookie) de l'app
      APP_SESSION_SECRET: ${APP_SESSION_SECRET:-change-me}
      # URL du service twitch-api interne
      TWITCH_API_BASE_URL: http://twitch-api:8081
      ANALYSIS_BASE_URL: http://analysis:8083
    networks:
    - backend
    # - traefik
    labels:
    # Adapter ces labels à ta config Traefik[web:120][web:122][web:124]
    - "traefik.enable=true"
    - "traefik.http.routers.tca-gateway.rule=Host(`${TCA_HOSTNAME:-twitch-analyser.local}`)"
    - "traefik.http.routers.tca-gateway.entrypoints=websecure"
    - "traefik.http.routers.tca-gateway.tls=true"
    - "traefik.http.services.tca-gateway.loadbalancer.server.port=8080"

  # twitch-api:
  #   build:
  #     context: .
  #     dockerfile: ./cmd/twitch-api/Dockerfile
  #   container_name: twitch-chatters-twitch-api
  #   restart: unless-stopped
  #   depends_on:
  #     db:
  #       condition: service_healthy
  #   environment:
  #     APP_ENV: ${APP_ENV:-dev}
  #     APP_PORT: "8081"
  #     DB_HOST: db
  #     DB_PORT: "3306"
  #     DB_NAME: ${MYSQL_DATABASE:-twitch_chatters}
  #     DB_USER: ${MYSQL_USER:-twitch}
  #     DB_PASSWORD: ${MYSQL_PASSWORD:-twitchpass}
  #     TWITCH_CLIENT_ID: ${TWITCH_CLIENT_ID}
  #     TWITCH_CLIENT_SECRET: ${TWITCH_CLIENT_SECRET}
  #     # Paramètres de rate limiting globaux (exemple)
  #     RATE_LIMIT_REQUESTS_PER_MINUTE: ${RATE_LIMIT_REQUESTS_PER_MINUTE:-600}
  #   networks:
  #   - backend

  worker:
    build:
      context: .
      dockerfile: ./cmd/worker/Dockerfile
    container_name: twitch-chatters-worker
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      # twitch-api:
      #   condition: service_started
    environment:
      APP_ENV: ${APP_ENV:-dev}
      DB_HOST: db
      DB_PORT: "3306"
      DB_NAME: ${MYSQL_DATABASE:-twitch_chatters}
      DB_USER: ${MYSQL_USER:-twitch}
      DB_PASSWORD: ${MYSQL_PASSWORD:-twitchpass}
      TWITCH_API_BASE_URL: http://twitch-api:8081
      TWITCH_CLIENT_ID: ${TWITCH_CLIENT_ID}
      # Intervalle de polling de la file de jobs (en secondes)
      JOB_POLL_INTERVAL: ${JOB_POLL_INTERVAL:-2}
    networks:
    - backend

  analysis:
    build:
      context: .
      dockerfile: ./cmd/analysis/Dockerfile
    container_name: twitch-chatters-analysis
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    ports:
    - "8083:8083"
    environment:
      APP_ENV: ${APP_ENV:-dev}
      APP_PORT: "8083"
      DB_HOST: db
      DB_PORT: "3306"
      DB_NAME: ${MYSQL_DATABASE:-twitch_chatters}
      DB_USER: ${MYSQL_USER:-twitch}
      DB_PASSWORD: ${MYSQL_PASSWORD:-twitchpass}
    networks:
    - backend

networks:
  backend:
    driver: bridge
  # traefik:
  #   external: true

volumes:
  db_data:
