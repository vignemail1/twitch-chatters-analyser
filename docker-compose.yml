services:
  traefik:
    image: traefik:v3.2
    container_name: twitch-chatters-traefik
    restart: unless-stopped
    command:
      # API et Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=false"
      # Log level
      - "--log.level=INFO"
      - "--accesslog=true"
      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=backend"
      # Entrypoints HTTP/HTTPS
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Redirection HTTP -> HTTPS
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      # Let's Encrypt
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@vignemail1.eu}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt
    networks:
      - backend
    labels:
      # Dashboard Traefik (accès via traefik.vignemail1.eu)
      - "traefik.enable=true"
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.vignemail1.eu`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls=true"
      - "traefik.http.routers.traefik-dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      # Auth basique pour dashboard (user: admin, password: changeme)
      # Générer avec: echo $(htpasswd -nB admin) | sed -e s/\$/\$\$/g
      - "traefik.http.routers.traefik-dashboard.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=${TRAEFIK_AUTH:-admin:$$2y$$05$$qH9S4qMxRbW5KxG5jZLxTOpkH.4YLbXn1A8RvKVH8FqCqVzWHFKRi}"

  redis:
    image: redis:7-alpine
    container_name: twitch-chatters-redis
    restart: unless-stopped
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  db:
    image: mariadb:11.2
    container_name: twitch-chatters-db
    restart: unless-stopped
    environment:
      MARIADB_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpass}
      MARIADB_DATABASE: ${MYSQL_DATABASE:-twitch_chatters}
      MARIADB_USER: ${MYSQL_USER:-twitch}
      MARIADB_PASSWORD: ${MYSQL_PASSWORD:-twitchpass}
    command: [
      "--character-set-server=utf8mb4",
      "--collation-server=utf8mb4_unicode_ci",
      "--max-connections=200",
      "--innodb-buffer-pool-size=512M"
    ]
    volumes:
      - db_data:/var/lib/mysql
      - ./dev/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "healthcheck.sh --connect --innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  gateway:
    build:
      context: .
      dockerfile: ./cmd/gateway/Dockerfile
    container_name: twitch-chatters-gateway
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      twitch-api:
        condition: service_started
    # Communication interne uniquement, Traefik expose en HTTPS
    expose:
      - "8080"
    environment:
      APP_ENV: ${APP_ENV:-production}
      APP_PORT: "8080"
      DB_HOST: db
      DB_PORT: "3306"
      DB_NAME: ${MYSQL_DATABASE:-twitch_chatters}
      DB_USER: ${MYSQL_USER:-twitch}
      DB_PASSWORD: ${MYSQL_PASSWORD:-twitchpass}
      DB_MAX_OPEN_CONNS: "50"
      DB_MAX_IDLE_CONNS: "10"
      REDIS_URL: redis://redis:6379/0
      TWITCH_CLIENT_ID: ${TWITCH_CLIENT_ID}
      TWITCH_CLIENT_SECRET: ${TWITCH_CLIENT_SECRET}
      TWITCH_REDIRECT_URL: ${TWITCH_REDIRECT_URL}
      APP_SESSION_SECRET: ${APP_SESSION_SECRET:-change-me}
      TWITCH_API_BASE_URL: http://twitch-api:8081
      ANALYSIS_BASE_URL: http://analysis:8083
    networks:
      - backend
    labels:
      - "traefik.enable=true"
      # Production: twitch-chatters.vignemail1.eu
      - "traefik.http.routers.tca-gateway-prod.rule=Host(`twitch-chatters.vignemail1.eu`)"
      - "traefik.http.routers.tca-gateway-prod.entrypoints=websecure"
      - "traefik.http.routers.tca-gateway-prod.tls=true"
      - "traefik.http.routers.tca-gateway-prod.tls.certresolver=letsencrypt"
      - "traefik.http.routers.tca-gateway-prod.service=tca-gateway"
      # Dev: twitch-chatters-dev.vignemail1.eu
      - "traefik.http.routers.tca-gateway-dev.rule=Host(`twitch-chatters-dev.vignemail1.eu`)"
      - "traefik.http.routers.tca-gateway-dev.entrypoints=websecure"
      - "traefik.http.routers.tca-gateway-dev.tls=true"
      - "traefik.http.routers.tca-gateway-dev.tls.certresolver=letsencrypt"
      - "traefik.http.routers.tca-gateway-dev.service=tca-gateway"
      # Service
      - "traefik.http.services.tca-gateway.loadbalancer.server.port=8080"
      # Health check
      - "traefik.http.services.tca-gateway.loadbalancer.healthcheck.path=/healthz"
      - "traefik.http.services.tca-gateway.loadbalancer.healthcheck.interval=10s"

  twitch-api:
    build:
      context: .
      dockerfile: ./cmd/twitch-api/Dockerfile
    container_name: twitch-chatters-twitch-api
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    environment:
      APP_ENV: ${APP_ENV:-production}
      APP_PORT: "8081"
      REDIS_URL: redis://redis:6379/1
      TWITCH_CLIENT_ID: ${TWITCH_CLIENT_ID}
      TWITCH_CLIENT_SECRET: ${TWITCH_CLIENT_SECRET}
      # Rate limiting: 10 req/sec = 600 req/min (marge sous les 800 de Twitch)
      RATE_LIMIT_REQUESTS_PER_SECOND: ${RATE_LIMIT_REQUESTS_PER_SECOND:-10}
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8081/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  worker:
    build:
      context: .
      dockerfile: ./cmd/worker/Dockerfile
    container_name: twitch-chatters-worker
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      twitch-api:
        condition: service_healthy
    environment:
      APP_ENV: ${APP_ENV:-production}
      DB_HOST: db
      DB_PORT: "3306"
      DB_NAME: ${MYSQL_DATABASE:-twitch_chatters}
      DB_USER: ${MYSQL_USER:-twitch}
      DB_PASSWORD: ${MYSQL_PASSWORD:-twitchpass}
      DB_MAX_OPEN_CONNS: "20"
      DB_MAX_IDLE_CONNS: "5"
      REDIS_URL: redis://redis:6379/2
      TWITCH_API_BASE_URL: http://twitch-api:8081
      TWITCH_CLIENT_ID: ${TWITCH_CLIENT_ID}
      JOB_POLL_INTERVAL: ${JOB_POLL_INTERVAL:-2}
    networks:
      - backend

  analysis:
    build:
      context: .
      dockerfile: ./cmd/analysis/Dockerfile
    container_name: twitch-chatters-analysis
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    # Communication interne uniquement
    expose:
      - "8083"
    environment:
      APP_ENV: ${APP_ENV:-production}
      APP_PORT: "8083"
      DB_HOST: db
      DB_PORT: "3306"
      DB_NAME: ${MYSQL_DATABASE:-twitch_chatters}
      DB_USER: ${MYSQL_USER:-twitch}
      DB_PASSWORD: ${MYSQL_PASSWORD:-twitchpass}
      DB_MAX_OPEN_CONNS: "30"
      DB_MAX_IDLE_CONNS: "10"
      REDIS_URL: redis://redis:6379/3
      CACHE_TTL_SECONDS: ${CACHE_TTL_SECONDS:-300}
    networks:
      - backend

networks:
  backend:
    driver: bridge

volumes:
  db_data:
  redis_data:
  traefik_letsencrypt:
