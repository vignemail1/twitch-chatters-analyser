# Configuration mise (https://mise.jdx.dev)
# Gestion des outils et variables d'environnement du projet

[tools]
# Versions des outils de d√©veloppement
go = "1.25"
node = "22"
python = "3.12"

# fnox pour la gestion des secrets
# https://fnox.jdx.dev
fnox = "latest"

[env]
# Variables techniques (pas de secrets)
COMPOSE_PROJECT_NAME = "twitch-chatters-analyser"
DOCKER_BUILDKIT = "1"
COMPOSE_DOCKER_CLI_BUILD = "1"

# Chargement du .env selon le profil
# mise charge automatiquement les .env, pas besoin de direnv
_.file = [
  ".env",
  { path = ".env.local", optional = true }
]

_.path = [
  "./bin",
  "./scripts"
]

# ===========================================
# T√ÇCHES
# ===========================================

[tasks.install]
description = "Installer les d√©pendances Go"
run = "go mod download"

[tasks.build]
description = "Builder les images Docker"
run = "docker-compose build"

[tasks."build:nocache"]
description = "Builder les images Docker sans cache"
run = "docker-compose build --no-cache"

[tasks.up]
description = "D√©marrer tous les services (utilise le profil actif)"
run = """
#!/usr/bin/env bash
set -e

if [ "$ENABLE_MONITORING" = "true" ]; then
  echo "üìä D√©marrage avec monitoring ($APP_ENV)"
  docker-compose -f docker-compose.yml -f docker-compose.monitoring.yml up -d
else
  echo "üöÄ D√©marrage sans monitoring ($APP_ENV)"
  docker-compose up -d
fi
"""

[tasks."up:dev"]
description = "D√©marrer en mode d√©veloppement (ports expos√©s, 1 replica)"
run = "docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d"

[tasks."up:prod"]
description = "D√©marrer en mode production (monitoring inclus)"
env = { MISE_ENV = "production" }
run = "docker-compose -f docker-compose.yml -f docker-compose.monitoring.yml up -d"

[tasks.down]
description = "Arr√™ter tous les services"
run = "docker-compose down"

[tasks."down:volumes"]
description = "Arr√™ter et supprimer les volumes (ATTENTION: perte de donn√©es)"
run = "docker-compose down -v"

[tasks.restart]
description = "Red√©marrer tous les services"
run = """
#!/usr/bin/env bash
mise run down
mise run up
"""

[tasks.logs]
description = "Afficher les logs de tous les services"
run = "docker-compose logs -f"

[tasks."logs:gateway"]
description = "Afficher les logs du gateway"
run = "docker-compose logs -f gateway"

[tasks."logs:worker"]
description = "Afficher les logs du worker"
run = "docker-compose logs -f worker"

[tasks."logs:db"]
description = "Afficher les logs de la base de donn√©es"
run = "docker-compose logs -f db"

[tasks.ps]
description = "Afficher l'√©tat des services"
run = "docker-compose ps"

[tasks.test]
description = "Lancer les tests"
run = "go test -v ./..."

[tasks."test:coverage"]
description = "Lancer les tests avec couverture"
run = "go test -cover -coverprofile=coverage.out ./..."

[tasks.lint]
description = "Linter le code Go"
run = "golangci-lint run"

[tasks."lint:fix"]
description = "Linter et corriger automatiquement"
run = "golangci-lint run --fix"

[tasks.env-check]
description = "V√©rifier que toutes les variables d'environnement sont d√©finies"
run = """
#!/usr/bin/env bash
set -e

echo "üîç V√©rification des variables pour l'environnement: $APP_ENV"
echo ""

REQUIRED_VARS=(
  "APP_ENV"
  "TWITCH_CLIENT_ID"
  "TWITCH_CLIENT_SECRET"
  "TWITCH_REDIRECT_URL"
  "MYSQL_ROOT_PASSWORD"
  "MYSQL_PASSWORD"
  "MYSQL_DATABASE"
  "MYSQL_USER"
  "APP_SESSION_SECRET"
  "ACME_EMAIL"
  "TRAEFIK_AUTH"
)

MISSING_VARS=()

for var in "${REQUIRED_VARS[@]}"; do
  if [ -z "${!var}" ]; then
    MISSING_VARS+=("$var")
  fi
done

if [ ${#MISSING_VARS[@]} -gt 0 ]; then
  echo "‚ùå Variables manquantes dans .env.$APP_ENV :"
  for var in "${MISSING_VARS[@]}"; do
    echo "  - $var"
  done
  echo ""
  echo "üìù Actions possibles :"
  echo "  1. Copier .env.example vers .env.$APP_ENV"
  echo "  2. G√©n√©rer les secrets: mise run secrets:generate"
  echo "  3. Utiliser fnox pour les secrets: fnox secrets"
  echo "  4. Remplir les valeurs manquantes"
  exit 1
fi

echo "‚úÖ Toutes les variables d'environnement requises sont d√©finies"
echo "üåê Environnement: $APP_ENV"
echo "üîó Redirect URL: $TWITCH_REDIRECT_URL"
echo "üìä Monitoring: $ENABLE_MONITORING"
"""

[tasks."secrets:generate"]
alias = "env-generate"
description = "G√©n√©rer les secrets pour .env (utiliser fnox est recommand√©)"
run = """
#!/usr/bin/env bash
set -e

echo "# ======================================"
echo "# Secrets g√©n√©r√©s automatiquement"
echo "# ======================================"
echo ""
echo "‚ö†Ô∏è  Recommandation: Utiliser fnox pour g√©rer les secrets"
echo "   fnox permet un stockage s√©curis√© et une injection automatique"
echo ""

echo "# MySQL Root Password"
echo "MYSQL_ROOT_PASSWORD=$(openssl rand -base64 32)"
echo ""

echo "# MySQL User Password"
echo "MYSQL_PASSWORD=$(openssl rand -base64 32)"
echo ""

echo "# App Session Secret"
echo "APP_SESSION_SECRET=$(openssl rand -base64 32)"
echo ""

if command -v htpasswd &> /dev/null; then
  echo "# Traefik Auth (admin/changeme)"
  echo "# G√©n√©rer un nouveau mot de passe : htpasswd -nB admin"
  echo "TRAEFIK_AUTH=$(echo $(htpasswd -nB admin 2>/dev/null) | sed -e 's/\\$/\\$\\$/g')"
else
  echo "# Traefik Auth (installer apache2-utils pour g√©n√©rer)"
  echo "# TRAEFIK_AUTH=admin:\\$\\$2y\\$\\$05\\$\\$..."
fi

echo ""
echo "üìù Copier ces valeurs dans .env.development et .env.production"
echo "üîí Utiliser des secrets diff√©rents pour dev et prod!"
echo ""
echo "ü¶û Ou utiliser fnox pour une gestion s√©curis√©e:"
echo "   mise run secrets:setup"
"""

[tasks."secrets:setup"]
description = "Configurer fnox pour la gestion des secrets"
run = """
#!/usr/bin/env bash
set -e

echo "ü¶û Configuration de fnox pour la gestion des secrets"
echo ""

if ! command -v fnox &> /dev/null; then
  echo "‚ùå fnox n'est pas install√©"
  echo "Installation via mise: mise install fnox"
  exit 1
fi

echo "fnox permet de stocker les secrets de mani√®re s√©curis√©e"
echo "et de les injecter automatiquement dans l'environnement."
echo ""
echo "Documentation: https://fnox.jdx.dev/secrets.html"
echo ""
echo "Exemples de commandes:"
echo "  fnox secret set development MYSQL_ROOT_PASSWORD"
echo "  fnox secret set production TWITCH_CLIENT_ID"
echo "  fnox secrets list"
echo "  fnox secrets export development"
echo ""
"""

[tasks."env:dev"]
description = "Activer le profil development"
run = """
#!/usr/bin/env bash
echo "üõ†Ô∏è  Activation du profil DEVELOPMENT"
echo "export MISE_ENV=development" > .mise.env.local
echo "‚úÖ Profil development activ√©"
echo "Red√©marrer le shell ou lancer: eval \"$(mise activate bash)\""
"""

[tasks."env:prod"]
description = "Activer le profil production"
run = """
#!/usr/bin/env bash
echo "üöÄ Activation du profil PRODUCTION"
echo "export MISE_ENV=production" > .mise.env.local
echo "‚úÖ Profil production activ√©"
echo "Red√©marrer le shell ou lancer: eval \"$(mise activate bash)\""
"""

[tasks."env:staging"]
description = "Activer le profil staging"
run = """
#!/usr/bin/env bash
echo "üß™ Activation du profil STAGING"
echo "export MISE_ENV=staging" > .mise.env.local
echo "‚úÖ Profil staging activ√©"
echo "Red√©marrer le shell ou lancer: eval \"$(mise activate bash)\""
"""

[tasks.db-backup]
description = "Backup de la base de donn√©es"
run = """
#!/usr/bin/env bash
BACKUP_FILE="backup-$APP_ENV-$(date +%Y%m%d-%H%M%S).sql"
echo "üíæ Backup de $APP_ENV vers $BACKUP_FILE"
docker exec twitch-chatters-db mariadb-dump -u root -p"$MYSQL_ROOT_PASSWORD" twitch_chatters > "$BACKUP_FILE"
echo "‚úÖ Backup sauvegard√©: $BACKUP_FILE"
"""

[tasks.db-restore]
description = "Restaurer la base de donn√©es (argument: fichier)"
run = """
#!/usr/bin/env bash
if [ -z "$1" ]; then
  echo "‚ùå Usage: mise run db-restore <fichier.sql>"
  exit 1
fi

if [ ! -f "$1" ]; then
  echo "‚ùå Fichier $1 introuvable"
  exit 1
fi

echo "‚ö†Ô∏è  Restauration de $1 vers $APP_ENV"
read -p "Confirmer? (y/N) " -n 1 -r
echo

if [[ $REPLY =~ ^[Yy]$ ]]; then
  docker exec -i twitch-chatters-db mariadb -u root -p"$MYSQL_ROOT_PASSWORD" twitch_chatters < "$1"
  echo "‚úÖ Base de donn√©es restaur√©e"
else
  echo "‚ùå Annul√©"
fi
"""

[tasks.db-console]
description = "Ouvrir la console MariaDB"
run = "docker exec -it twitch-chatters-db mariadb -u root -p\"$MYSQL_ROOT_PASSWORD\" twitch_chatters"

[tasks.redis-console]
description = "Ouvrir la console Redis"
run = "docker exec -it twitch-chatters-redis redis-cli"

[tasks.clean]
description = "Nettoyer les fichiers temporaires"
run = """
#!/usr/bin/env bash
echo "üßπ Nettoyage..."
go clean
rm -f coverage.out
rm -f *.log
echo "‚úÖ Nettoyage termin√©"
"""
